<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Menú - Pupusería</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <div class="container">
        <div class="header-actions">
            <h1>Menú de Productos</h1>
            <div>
                <button class="theme-toggle" id="themeToggle">Modo Oscuro</button>
                <a href="index.html"><button style="margin-left: 10px;">Volver a Ventas</button></a>
            </div>
        </div>

        <p class="subtitle">Administra los productos disponibles en el sistema.</p>

        <!-- Botón para agregar producto -->
        <div style="margin-bottom: 20px;">
            <button onclick="abrirModalNuevo()" style="background-color: #27ae60;">➕ Agregar Producto</button>
        </div>

        <!-- Tabla de productos -->
        <table id="productosTable" class="historial-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="productosBody"></tbody>
        </table>
    </div>

    <!-- Modal para agregar/editar -->
    <div class="ticket" id="productoModal" style="display: none;">
        <div class="ticket-content" style="width: 400px;">
            <h2 id="modalTitulo">Agregar Producto</h2>
            <form id="productoForm">
                <input type="hidden" id="productoId">
                <div style="margin: 15px 0;">
                    <label>Nombre:</label>
                    <input type="text" id="nombre" required style="width: 100%; padding: 8px; margin-top: 5px;">
                </div>
                <div style="margin: 15px 0;">
                    <label>Precio:</label>
                    <input type="number" id="precio" step="0.01" required style="width: 100%; padding: 8px; margin-top: 5px;">
                </div>
                <div class="ticket-buttons">
                    <button type="submit" style="background: #27ae60;">Guardar</button>
                    <button type="button" onclick="cerrarModal()" class="close-ticket">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- jQuery y DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <script>
        let productos = [];
        const modal = document.getElementById('productoModal');
        const form = document.getElementById('productoForm');

        // Cargar productos al iniciar
        function cargarProductos() {
            fetch('backend/obtener_productos.php')
                .then(res => res.json())
                .then(data => {
                    productos = data;
                    const tbody = document.getElementById('productosBody');
                    tbody.innerHTML = '';

                    data.forEach((prod, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
              <td>${index + 1}</td>
              <td>${prod.nombre}</td>
              <td>$${parseFloat(prod.precio).toFixed(2)}</td>
              <td>
                <button onclick="editarProducto(${prod.id})" style="background:#f39c12;"><i class="fas fa-edit"></i> Editar</button>
                <button onclick="eliminarProducto(${prod.id})" style="background:#e74c3c;"><i class="fas fa-trash"></i> Eliminar</button>
              </td>
            `;
                        tbody.appendChild(tr);
                    });

                    // Inicializar DataTables
                    if ($.fn.DataTable.isDataTable('#productosTable')) {
                        $('#productosTable').DataTable().destroy();
                    }
                    $('#productosTable').DataTable({
                        dom: 'Bfrtip',
                        buttons: ['excelHtml5', 'csvHtml5', 'print'],
                        language: {
                            url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                        },
                        pageLength: 10
                    });
                })
                .catch(err => {
                    console.error("Error al cargar productos:", err);
                    alert("No se pudieron cargar los productos.");
                });
        }

        // Abrir modal para nuevo producto
        function abrirModalNuevo() {
            document.getElementById('modalTitulo').textContent = 'Agregar Producto';
            form.reset();
            document.getElementById('productoId').value = '';
            modal.style.display = 'flex';
        }

        // Editar producto
        function editarProducto(id) {
            const prod = productos.find(p => p.id == id);
            if (!prod) return;

            document.getElementById('modalTitulo').textContent = 'Editar Producto';
            document.getElementById('productoId').value = prod.id;
            document.getElementById('nombre').value = prod.nombre;
            document.getElementById('precio').value = prod.precio;
            modal.style.display = 'flex';
        }

        // Eliminar producto
        function eliminarProducto(id) {
            if (confirm("¿Eliminar este producto? Se eliminará de todas las ventas futuras.")) {
                fetch('backend/eliminar_producto.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `id=${id}`
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert("Producto eliminado.");
                            cargarProductos(); // Refrescar
                        } else {
                            alert("Error: " + data.message);
                        }
                    })
                    .catch(err => {
                        console.error("Error:", err);
                        alert("Hubo un error al eliminar.");
                    });
            }
        }

        // Guardar (crear o editar)
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('productoId').value;
            const nombre = document.getElementById('nombre').value;
            const precio = document.getElementById('precio').value;

            const url = id ? 'backend/editar_producto.php' : 'backend/agregar_producto.php';
            const body = id ? `id=${id}&nombre=${nombre}&precio=${precio}` : `nombre=${nombre}&precio=${precio}`;

            fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Producto ${id ? 'actualizado' : 'agregado'} con éxito.`);
                        cerrarModal();
                        cargarProductos();
                    } else {
                        alert("Error: " + data.message);
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                    alert("Hubo un error al guardar.");
                });
        });

        // Cerrar modal
        function cerrarModal() {
            modal.style.display = 'none';
        }

        // Cerrar al hacer clic fuera
        window.onclick = function(e) {
            if (e.target === modal) cerrarModal();
        };

        // Inicializar
        cargarProductos();

        // ===== MODO OSCURO =====
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        // Verificar preferencia guardada
        if (localStorage.getItem('darkMode') === 'true') {
            body.classList.add('dark-mode');
            themeToggle.textContent = 'Modo Claro';
        }

        // Alternar modo
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            themeToggle.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
        });


        setInterval(cargarMenu, 5000); // Cada 5 segundos
    </script>
</body>

</html>